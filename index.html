<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Analisador de Extrato Banc√°rio Avan√ßado</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3498db; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-5xl bg-white rounded-xl shadow-lg p-6 md:p-8">

        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">üìÑ Analisador de Extrato Banc√°rio Avan√ßado</h1>
            <p class="text-gray-600 mt-2">Envie m√∫ltiplos extratos, selecione o banco e obtenha relat√≥rios consolidados.</p>
        </div>

        <!-- Passo 1: Configura√ß√£o -->
        <div class="mb-6 bg-gray-50 p-4 rounded-lg border">
            <h2 class="text-xl font-bold text-gray-700 border-b pb-2 mb-4">1. Suas Informa√ß√µes e Filtros Gerais</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                <div>
                    <label for="userName" class="block text-sm font-medium text-gray-700 mb-1">Nome completo:</label>
                    <input type="text" id="userName" placeholder="Ex: JOAO DA SILVA SANTOS" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="identifiers" class="block text-sm font-medium text-gray-700 mb-1">Outras identifica√ß√µes (CPF, e-mail, etc - separados por v√≠rgula):</label>
                    <input type="text" id="identifiers" placeholder="000.000.000-00, joao@email.com" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="minValue" class="block text-sm text-gray-700 mb-1">Ignorar valores abaixo de:</label>
                    <input type="text" id="minValue" placeholder="Ex: 1,00" class="w-full px-4 py-2 border rounded-lg" oninput="formatCurrencyInput(this)">
                </div>
                <div>
                    <label for="maxValue" class="block text-sm text-gray-700 mb-1">Ignorar valores acima de:</label>
                    <input type="text" id="maxValue" placeholder="Ex: 1000,00" class="w-full px-4 py-2 border rounded-lg" oninput="formatCurrencyInput(this)">
                </div>
                <div class="md:col-span-2">
                    <label for="rendaComprovada" class="block text-sm font-medium text-gray-700">Renda Comprovada (mensal):</label>
                    <input type="text" id="rendaComprovada" placeholder="Ex: 2.500,00" oninput="formatCurrencyInput(this)" class="w-full border px-4 py-2 rounded-lg">
                </div>
            </div>
             <button onclick="salvarIdentificacoes()" class="mt-4 bg-blue-100 text-blue-700 px-3 py-1 rounded text-sm hover:bg-blue-200 transition">
                üíæ Salvar Informa√ß√µes no Navegador
            </button>
        </div>

        <!-- Passo 2: Upload de M√∫ltiplos Arquivos -->
        <div class="mb-6">
            <h2 class="text-xl font-bold text-gray-700 border-b pb-2 mb-4">2. Envie os Extratos em PDF</h2>
            <label for="pdfUpload" class="block w-full cursor-pointer bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:bg-gray-200">
                <span class="text-blue-600 font-semibold">Clique aqui para selecionar os arquivos</span>
                <input type="file" id="pdfUpload" accept=".pdf" class="hidden" multiple>
            </label>
            <div id="file-list" class="mt-4 space-y-2"></div>
        </div>
        
        <button id="process-button" onclick="processAllFiles()" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-300 text-lg disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
            Processar Extratos
        </button>
        <div id="loading" class="hidden flex items-center justify-center mt-4">
            <div class="loader"></div>
            <p id="loading-text" class="ml-4 text-gray-600">Processando... Isso pode levar v√°rios segundos.</p>
        </div>
        
        <!-- Se√ß√£o de Resultados -->
        <div id="results" class="mt-10 hidden">
            <hr class="mb-8">
            <h2 class="text-2xl font-bold text-gray-800 text-center mb-6">‚úîÔ∏è Resultados Consolidados</h2>
            
            <div id="credit-analysis-panel" class="mt-6 mb-8 hidden">
                <h2 class="text-2xl font-bold text-gray-800 text-center mb-6">üí° An√°lise de Cr√©dito Sugerida</h2>
                <div id="credit-summary" class="grid grid-cols-1 md:grid-cols-2 gap-4 text-center mb-6 p-4 bg-indigo-50 border border-indigo-200 rounded-lg"></div>
            </div>

            <div id="dashboard" class="mt-10 hidden">
                <h2 class="text-2xl font-bold text-gray-800 text-center mb-6">üìä Painel Financeiro Interativo</h2>
                <div class="p-4 bg-gray-50 rounded-lg border">
                    <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="showSelfTransfers" class="h-4 w-4 rounded text-blue-600 focus:ring-blue-500" onchange="renderDashboard()">
                            <label for="showSelfTransfers" class="text-sm font-medium text-gray-700">Incluir transfer√™ncias para mim</label>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-700 mr-2">Filtrar por tipo:</label>
                            <select id="filterType" onchange="renderDashboard()" class="border border-gray-300 px-2 py-1 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="todos">Todos</option>
                                <option value="entrada">Entradas</option>
                                <option value="saida">Sa√≠das</option>
                                <option value="self">Para Mim</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center mb-6" id="dashboardStats"></div>
                    <div class="overflow-auto border rounded-lg max-h-[400px]" id="dashboardTable"></div>
                </div>
            </div>
            
            <div class="mt-8 text-center">
                <button onclick="abrirModalManual()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
                    ‚ûï Adicionar Manualmente
                </button>
            </div>

            <div id="export-buttons" class="mt-8 text-center">
                <h3 class="text-lg font-bold text-gray-700 mb-4">üì§ Exportar Relat√≥rios Consolidados</h3>
                <div class="flex flex-wrap gap-4 justify-center">
                    <button onclick="exportAllToXLSX()" class="bg-green-700 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-800 transition-colors">Exportar Planilha (XLSX)</button>
                    <button onclick="exportToPDF()" class="bg-red-700 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-800 transition-colors">Exportar Relat√≥rio (PDF)</button>
                </div>
            </div>

            <div class="mt-6 text-center space-x-4">
                <button onclick="mostrarAprendizados()" class="bg-yellow-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-yellow-600">
                    ‚öôÔ∏è Ver/Gerenciar Padr√µes Aprendidos
                </button>
                <button onclick="limparSessao()" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">
                    üßπ Limpar Atividade Atual
                </button>
            </div>
        </div>

        <!-- Modals -->
        <div id="custom-alert" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
             <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
                 <p id="alert-message" class="text-gray-800 text-lg mb-4"></p>
                 <button onclick="closeAlert()" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors">OK</button>
             </div>
        </div>
        
        <div id="classificationModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white p-6 rounded-lg w-full max-w-md shadow-lg">
                <h2 class="text-xl font-bold text-gray-800 mb-2">Classificar Transa√ß√£o</h2>
                <p class="text-gray-600 mb-4">Como voc√™ classifica esta transa√ß√£o desconhecida?</p>
                <div class="bg-gray-100 p-4 rounded-lg mb-4 text-center">
                    <p id="transactionDescription" class="font-mono text-gray-800"></p>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="classifyTransaction('entrada')" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">Entrada</button>
                    <button onclick="classifyTransaction('saida')" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors">Sa√≠da</button>
                    <button onclick="classifyTransaction('self')" class="bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors">Para Mim</button>
                    <button onclick="classifyTransaction('ignorar')" class="bg-yellow-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-yellow-600 transition-colors">Ignorar</button>
                    <button onclick="voltarClassificacao()" class="col-span-2 bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors mt-2">üîô Voltar √öltima Classifica√ß√£o</button>
                </div>
            </div>
        </div>

        <div id="aprendizadoModal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 p-4">
            <div class="bg-white p-6 rounded-lg w-full max-w-3xl shadow-lg overflow-y-auto max-h-[80vh]">
                <h2 class="text-xl font-bold text-gray-700 mb-4">üìö Padr√µes Aprendidos</h2>
                <div id="listaAprendizadosContainer" class="overflow-auto">
                    <table class="w-full text-sm border">
                        <thead><tr class="bg-gray-100"><th class="text-left p-2">Descri√ß√£o</th><th class="text-left p-2">Categoria</th><th></th></tr></thead>
                        <tbody id="listaAprendizados"></tbody>
                    </table>
                </div>
                <div class="mt-4 flex justify-between items-center gap-4">
                    <div>
                        <button onclick="exportarAprendizados()" class="bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700 text-sm">‚¨áÔ∏è Exportar JSON</button>
                        <input type="file" id="importAprendizados" accept=".json" class="hidden" onchange="importarAprendizados(event)">
                        <button onclick="document.getElementById('importAprendizados').click()" class="bg-purple-600 text-white py-2 px-4 rounded hover:bg-purple-700 text-sm">‚¨ÜÔ∏è Importar JSON</button>
                    </div>
                    <button onclick="fecharAprendizados()" class="bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700">Fechar</button>
                </div>
            </div>
        </div>
        
        <div id="modalManual" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div class="bg-white p-6 rounded-lg shadow-md w-full max-w-md">
            <h3 class="text-lg font-bold mb-4">Adicionar Transa√ß√£o Manual</h3>
            <input type="text" id="manualDate" placeholder="Data (DD/MM/AAAA)" class="w-full border mb-2 px-3 py-2 rounded">
            <input type="text" id="manualDesc" placeholder="Descri√ß√£o" class="w-full border mb-2 px-3 py-2 rounded">
            <input type="text" id="manualValor" placeholder="Valor ex: 150,00 (use - para sa√≠das)" class="w-full border mb-2 px-3 py-2 rounded" oninput="formatCurrencyInput(this, true)">
            <select id="manualTipo" class="w-full border mb-4 px-3 py-2 rounded">
                <option value="entrada">Entrada</option>
                <option value="saida">Sa√≠da</option>
                <option value="self">Para Mim</option>
            </select>
            <div class="flex justify-end gap-2">
                <button onclick="fecharModalManual()" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500">Cancelar</button>
                <button onclick="salvarManual()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Salvar</button>
            </div>
          </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <script>
        (function() {
            const tokenEsperado = "segredo123";
            const urlParams = new URLSearchParams(window.location.search);
            const tokenRecebido = urlParams.get("token");
            if (tokenRecebido !== tokenEsperado) {
                document.body.innerHTML = '<div class="p-6 text-center text-red-600 font-bold text-lg">üîí Acesso negado. Token inv√°lido.</div>';
                throw new Error("Acesso negado");
            }
        })();

        pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js";
        
        let filesToProcess = [];
        let income = [], expenses = [], selfTransfers = [];
        let transacoesFixas = new Set();
        let currentTransactionToClassify = null, resolveClassificationPromise = null;
        let previousClassification = null;

        const pdfUpload = document.getElementById('pdfUpload');
        const fileListDiv = document.getElementById('file-list');
        const processButton = document.getElementById('process-button');
        const loadingIndicator = document.getElementById('loading');

        window.onload = function() {
            const savedUser = localStorage.getItem("userName");
            const savedIds = localStorage.getItem("userIdentifiers");
            if (savedUser) document.getElementById('userName').value = savedUser;
            if (savedIds) document.getElementById('identifiers').value = savedIds;
            if(savedUser || savedIds) showAlert("Informa√ß√µes de usu√°rio salvas foram carregadas.");
        };

        pdfUpload.addEventListener('change', (event) => {
            const newFiles = Array.from(event.target.files);
            newFiles.forEach(file => {
                if(!filesToProcess.some(f => f.name === file.name)) {
                    filesToProcess.push({ file, name: file.name, selectedBank: 'generico', id: `file_${Date.now()}_${Math.random()}` });
                }
            });
            renderFileList();
            processButton.disabled = filesToProcess.length === 0;
            event.target.value = '';
        });
        
        function renderFileList() {
            fileListDiv.innerHTML = '';
            filesToProcess.forEach((fileWrapper, index) => {
                const fileElement = document.createElement('div');
                fileElement.className = 'flex items-center justify-between p-2 bg-gray-100 rounded-lg';
                const bankOptions = Object.keys(parsers).map(key => `<option value="${key}" ${fileWrapper.selectedBank === key ? 'selected' : ''}>${formatBankName(key)}</option>`).join('');
                
                fileElement.innerHTML = `
                    <span class="text-sm font-medium text-gray-800">${fileWrapper.name}</span>
                    <div class="flex items-center gap-2">
                        <select onchange="updateFileBank(${index}, this.value)" class="border border-gray-300 px-2 py-1 rounded-lg text-sm">
                            ${bankOptions}
                        </select>
                        <button onclick="removeFile(${index})" class="text-red-500 hover:text-red-700 font-bold text-lg">&times;</button>
                    </div>
                `;
                fileListDiv.appendChild(fileElement);
            });
        }
        
        function updateFileBank(index, bank) { filesToProcess[index].selectedBank = bank; }
        function removeFile(index) { filesToProcess.splice(index, 1); renderFileList(); processButton.disabled = filesToProcess.length === 0; }

        async function processAllFiles() {
            income = []; expenses = []; selfTransfers = []; transacoesFixas.clear();
            loadingIndicator.style.display = 'flex';
            
            const identifiers = getIdentifiers();
            if (identifiers.all.length === 0) {
                loadingIndicator.style.display = 'none';
                return showAlert('Por favor, insira o nome completo.');
            }
            
            for (const fileWrapper of filesToProcess) {
                const fileText = await readPdfFile(fileWrapper.file);
                const parser = parsers[fileWrapper.selectedBank] || parsers.generico;
                const transacoes = parser(fileText);
                await classifyAndProcessTransactions(transacoes, identifiers.all, fileWrapper.selectedBank);
            }
            
            loadingIndicator.style.display = 'none';
            renderDashboard();
        }

        async function readPdfFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const pdfData = new Uint8Array(e.target.result);
                        const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
                        let fullText = '';
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            let lastY = -1, lineBuffer = [];
                            textContent.items.forEach(item => {
                                if (lastY !== -1 && Math.abs(item.transform[5] - lastY) > 5) {
                                    fullText += lineBuffer.join(' ') + '\n';
                                    lineBuffer = [];
                                }
                                lineBuffer.push(item.str);
                                lastY = item.transform[5];
                            });
                            fullText += lineBuffer.join(' ') + '\n';
                        }
                        resolve(fullText);
                    } catch (error) { reject(error); }
                };
                reader.onerror = (error) => reject(error);
                reader.readAsArrayBuffer(file);
            });
        }

        async function classifyAndProcessTransactions(transacoes, allIdentifiers, bankName) {
            const minValue = parseFloat(document.getElementById("minValue").value.replace(/\./g, '').replace(',', '.')) || 0;
            const maxValue = parseFloat(document.getElementById("maxValue").value.replace(/\./g, '').replace(',', '.')) || 0;
            
            const transacoesFiltradas = transacoes.filter(t => {
                const absValue = Math.abs(t.value);
                const minOk = minValue === 0 || absValue >= minValue;
                const maxOk = maxValue === 0 || absValue <= maxValue;
                return minOk && maxOk;
            });
            
            const learnedPatterns = loadLearnedPatterns();
            const keywordsSaida = ['pagamento', 'pix enviado', 'transfer√™ncia enviada', 'transfer√™ncia pix enviada', 'compra', 'boleto', 'saque', 'd√©bito', 'envio', 'pix para', 'transferido para', 'tarifa', 'mensalidade'];
            const keywordsEntrada = ['pix recebido', 'transfer√™ncia recebida', 'transfer√™ncia pix recebida', 'dep√≥sito', 'entrada', 'cr√©dito', 'sal√°rio', 'rendimento', 'recebido de', 'transferido de', 'pix de', 'recebimento'];
            
            for (const t of transacoesFiltradas) {
                t.id = `tx_${Date.now()}_${Math.random()}`; 
                t.bank = formatBankName(bankName);
                const descKey = t.description.toLowerCase();
                let category = learnedPatterns[descKey];
                
                if (!category) {
                    const isSelf = allIdentifiers.some(id => descKey.includes(id));
                    if (isSelf) {
                        category = 'self';
                    } else if (keywordsSaida.some(k => descKey.includes(k))) {
                        category = 'saida';
                    } else if (keywordsEntrada.some(k => descKey.includes(k))) {
                        category = 'entrada';
                    } else {
                        category = await askForClassification(t);
                    }
                    if (category && category !== 'ignorar') {
                        learnedPatterns[descKey] = category;
                        saveLearnedPatterns(learnedPatterns);
                    }
                }

                if (category === 'self') selfTransfers.push(t);
                else if (category === 'entrada') income.push(t);
                else if (category === 'saida') expenses.push(t);
            }
        }
        
        function renderDashboard() {
            document.getElementById('results').classList.remove('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            const showSelf = document.getElementById('showSelfTransfers').checked;
            const tipoFiltro = document.getElementById('filterType').value;

            let transacoesVisiveis = [];
            if (tipoFiltro === 'todos' || tipoFiltro === 'entrada') transacoesVisiveis.push(...income.map(t => ({...t, tipo: 'entrada'})));
            if (tipoFiltro === 'todos' || tipoFiltro === 'saida') transacoesVisiveis.push(...expenses.map(t => ({...t, tipo: 'saida'})));
            
            if (showSelf || tipoFiltro === 'self') {
                 const selfIdsInTable = new Set(transacoesVisiveis.map(t => t.id));
                 const newSelfTransfers = selfTransfers.filter(t => !selfIdsInTable.has(t.id));
                 transacoesVisiveis.push(...newSelfTransfers.map(t => ({...t, tipo: 'self'})));
            }
            
            let transacoesParaCalculo = [...income, ...expenses];
            if (showSelf) transacoesParaCalculo.push(...selfTransfers);
            
            let totalEntradasCalc = transacoesParaCalculo.filter(t => t.value > 0).reduce((acc, t) => acc + t.value, 0);
            let totalSaidasCalc = transacoesParaCalculo.filter(t => t.value < 0).reduce((acc, t) => acc + t.value, 0);
            let saldoCalc = totalEntradasCalc + totalSaidasCalc;

            document.getElementById('dashboardStats').innerHTML = `
                <div class="bg-green-100 p-4 rounded-lg"><p class="text-green-700 font-semibold">Entradas</p><p class="text-2xl font-bold">${formatCurrency(totalEntradasCalc)}</p></div>
                <div class="bg-red-100 p-4 rounded-lg"><p class="text-red-700 font-semibold">Sa√≠das</p><p class="text-2xl font-bold">${formatCurrency(totalSaidasCalc)}</p></div>
                <div class="bg-blue-100 p-4 rounded-lg"><p class="text-blue-700 font-semibold">Saldo</p><p class="text-2xl font-bold">${formatCurrency(saldoCalc)}</p></div>`;

            let table = `<table class="min-w-full text-sm"><thead class="bg-gray-100">
                <tr><th class="p-2 text-left">Data</th><th class="p-2 text-left">Banco</th><th class="p-2 text-left">Descri√ß√£o</th><th class="p-2 text-right">Valor</th><th class="p-2">Tipo</th><th class="p-2">A√ß√µes</th></tr></thead><tbody>`;
            transacoesVisiveis.forEach((t) => {
                const tipoNome = t.tipo === 'entrada' ? 'Entrada' : t.tipo === 'saida' ? 'Sa√≠da' : 'Para Mim';
                const cor = t.tipo === 'entrada' ? 'text-green-600' : t.tipo === 'saida' ? 'text-red-600' : 'text-gray-500';
                const fixoIcon = transacoesFixas.has(t.id) ? '‚≠ê ' : '';
                table += `<tr class="border-t"><td class="p-2">${t.date}</td><td class="p-2">${t.bank}</td><td class="p-2">${fixoIcon}${t.description}</td>
                    <td class="p-2 text-right ${cor} font-semibold">${formatCurrency(t.value)}</td>
                    <td class="p-2 text-center capitalize">${tipoNome}</td>
                    <td class="p-2 text-center">
                        <button onclick="toggleFixo('${t.id}')" class="text-indigo-600 hover:underline text-xs mr-2">Fixo</button>
                        <button onclick="removerTransacao('${t.id}')" class="text-red-600 hover:underline text-xs">Remover</button>
                    </td></tr>`;
            });
            table += '</tbody></table>';
            document.getElementById('dashboardTable').innerHTML = table;
            
            renderCreditAnalysis();
        }
        
        function removerTransacao(id) {
            income = income.filter(t => t.id !== id);
            expenses = expenses.filter(t => t.id !== id);
            selfTransfers = selfTransfers.filter(t => t.id !== id);
            transacoesFixas.delete(id);
            renderDashboard();
        }
        
        function limparSessao() {
            income = []; expenses = []; selfTransfers = [];
            filesToProcess = []; transacoesFixas.clear();
            document.getElementById('file-list').innerHTML = '';
            document.getElementById('results').classList.add('hidden');
            processButton.disabled = true;
            showAlert("Atividade atual foi limpa. Dados salvos no navegador foram mantidos.");
        }

        function abrirModalManual() { document.getElementById('modalManual').classList.remove('hidden'); }
        function fecharModalManual() { document.getElementById('modalManual').classList.add('hidden'); }
        function salvarManual() {
            const date = document.getElementById("manualDate").value;
            const desc = document.getElementById("manualDesc").value;
            let rawVal = document.getElementById("manualValor").value;
            const tipo = document.getElementById("manualTipo").value;
            const isNegative = rawVal.startsWith('-');
            rawVal = rawVal.replace(/\D/g, ''); 
            let val = parseValue(rawVal);
            if(isNegative) val = -Math.abs(val);
            if (!date || !desc || isNaN(val)) { showAlert("Preencha corretamente todos os campos."); return; }
            const t = { id: `manual_${Date.now()}`, date, description: desc, value: val, bank: "Manual" };
            if (tipo === 'entrada') { if (t.value < 0) t.value = -t.value; income.push(t); }
            else if (tipo === 'saida') { if (t.value > 0) t.value = -t.value; expenses.push(t); }
            else selfTransfers.push(t);
            fecharModalManual();
            renderDashboard();
        }
        
        function toggleFixo(id) {
            if (transacoesFixas.has(id)) transacoesFixas.delete(id);
            else transacoesFixas.add(id);
            renderDashboard(); 
        }

        function renderCreditAnalysis() {
            const metrics = calculateCreditMetrics();
            document.getElementById('credit-analysis-panel').classList.remove('hidden');
            document.getElementById('credit-summary').innerHTML = `
                <div><p class="font-semibold text-indigo-700">Renda L√≠quida Estimada</p><p class="text-2xl font-bold">${formatCurrency(metrics.rendaLiquida)}</p></div>
                <div><p class="font-semibold text-indigo-700">Comprometimento de Renda</p><p class="text-2xl font-bold">${metrics.comprometimento}</p></div>`;
        }

        function calculateCreditMetrics() {
            const totalEntradas = income.reduce((s, t) => s + t.value, 0);
            const totalSaidas = expenses.reduce((s, t) => s + t.value, 0); 
            const comprometimento = (totalEntradas > 0) ? (Math.abs(totalSaidas) / totalEntradas) : 0;
            return {
                rendaLiquida: totalEntradas,
                comprometimento: (comprometimento * 100).toFixed(1) + '%'
            };
        }
        
        function calculateCreditScore(metrics) {
            const renda = metrics.rendaLiquida;
            const comp = parseFloat(metrics.comprometimento);
            if (renda >= 3000 && comp < 30) return { score: 850, risco: "Muito Baixo" };
            if (renda >= 2000 && comp < 40) return { score: 750, risco: "Baixo" };
            if (renda >= 1500 && comp < 50) return { score: 650, risco: "M√©dio" };
            return { score: 550, risco: "Alto" };
        }
        
        function generateMonthlyHistory() {
            const resumo = {};
            const allTransactions = [...income, ...expenses];
            for (const t of allTransactions) {
                try {
                    const dateParts = t.date.split('/');
                    if (dateParts.length < 2) continue;
                    let day = dateParts[0], month = dateParts[1], year = dateParts[2];
                    if (!year) year = new Date().getFullYear().toString();
                    if (year.length === 2) year = '20' + year;
                    const mesAno = `${month.padStart(2, '0')}/${year}`;
                    if (!resumo[mesAno]) resumo[mesAno] = { entradas: 0, saidas: 0 };
                    if (t.value > 0) resumo[mesAno].entradas += t.value;
                    else resumo[mesAno].saidas += t.value;
                } catch(e) { console.warn("Could not parse date for monthly history:", t.date); }
            }
            return Object.entries(resumo).map(([mes, dados]) => ({
                M√™s: mes, Entradas: dados.entradas, Sa√≠das: dados.saidas, Saldo: dados.entradas + dados.saidas
            }));
        }

        function getIdentifiers() {
             const u = document.getElementById('userName').value.trim().toLowerCase();
             const iR = document.getElementById('identifiers').value.trim().toLowerCase();
             const aI = iR.split(',').map(i => i.trim()).filter(Boolean);
             return { raw: document.getElementById('identifiers').value.trim(), all: [u, ...aI].filter(Boolean) };
        }
        function salvarIdentificacoes() { localStorage.setItem("userName", document.getElementById("userName").value.trim()); localStorage.setItem("userIdentifiers", document.getElementById("identifiers").value.trim()); showAlert("Identifica√ß√µes salvas com sucesso."); }
        function loadLearnedPatterns() { return JSON.parse(localStorage.getItem("aprendizadoTransacoes") || "{}"); }
        function saveLearnedPatterns(data) { localStorage.setItem("aprendizadoTransacoes", JSON.stringify(data)); }
        
        function askForClassification(transaction) {
            return new Promise(resolve => {
                if (!previousClassification || previousClassification.transaction.id !== transaction.id) {
                     previousClassification = { transaction, resolve };
                }
                currentTransactionToClassify = transaction;
                resolveClassificationPromise = resolve;
                document.getElementById('transactionDescription').textContent = transaction.description;
                document.getElementById('classificationModal').classList.remove('hidden');
            });
        }
        
        function classifyTransaction(category) {
            document.getElementById('classificationModal').classList.add('hidden');
            if (resolveClassificationPromise) {
                if(category !== 'ignorar') {
                    previousClassification = {
                        transaction: currentTransactionToClassify,
                        resolve: resolveClassificationPromise,
                        category: category,
                    };
                }
                resolveClassificationPromise(category);
                resolveClassificationPromise = null;
            }
        }

        function voltarClassificacao() {
            if (previousClassification && previousClassification.resolve) {
                const lastTransaction = previousClassification.transaction;
                
                if (previousClassification.category === 'entrada') income = income.filter(t => t.id !== lastTransaction.id);
                else if (previousClassification.category === 'saida') expenses = expenses.filter(t => t.id !== lastTransaction.id);
                else if (previousClassification.category === 'self') selfTransfers = selfTransfers.filter(t => t.id !== lastTransaction.id);

                const learned = loadLearnedPatterns();
                delete learned[lastTransaction.description.toLowerCase()];
                saveLearnedPatterns(learned);
                
                document.getElementById('classificationModal').classList.add('hidden');
                
                askForClassification(lastTransaction).then(newCategory => {
                    if (newCategory && newCategory !== 'ignorar') {
                        const patterns = loadLearnedPatterns();
                        patterns[lastTransaction.description.toLowerCase()] = newCategory;
                        saveLearnedPatterns(patterns);
                        
                        if (newCategory === 'self') selfTransfers.push(lastTransaction);
                        else if (newCategory === 'entrada') income.push(lastTransaction);
                        else if (newCategory === 'saida') expenses.push(lastTransaction);
                    }
                    renderDashboard();
                });

                 previousClassification = null;
            } else {
                showAlert("Nenhuma classifica√ß√£o anterior para voltar.");
            }
        }
        
        function mostrarAprendizados() { const d = loadLearnedPatterns(); const t = document.getElementById("listaAprendizados"); t.innerHTML = ""; Object.entries(d).forEach(([desc, tipo]) => { const r = document.createElement("tr"); r.innerHTML = `<td class="p-2 border-b">${desc}</td><td class="p-2 border-b capitalize">${tipo}</td><td class="p-2 border-b text-right"><button onclick="removerAprendizado('${desc}')" class="text-red-600 hover:underline text-sm">Remover</button></td>`; t.appendChild(r); }); document.getElementById("aprendizadoModal").classList.remove("hidden"); }
        function fecharAprendizados() { document.getElementById("aprendizadoModal").classList.add("hidden"); }
        function removerAprendizado(desc) { const d = loadLearnedPatterns(); delete d[desc]; saveLearnedPatterns(d); mostrarAprendizados(); }
        const parseValue = (str) => { if (typeof str !== 'string') str = String(str); return parseFloat(str.replace(/[^\d,-]/g, '').replace(/\./g, '').replace(',', '.')); };
        function formatBankName(key) { return key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()); }
        function formatCurrencyInput(input, allowNegative = false) { let value = input.value; const isNegative = allowNegative && value.startsWith('-'); if(isNegative) value = value.substring(1); value = value.replace(/\D/g, ''); if (!value) { input.value = ''; return; } value = (parseInt(value, 10) || 0).toString(); if (value.length < 3) value = value.padStart(3, '0'); let result = value.slice(0, -2) + ',' + value.slice(-2); if (isNegative) result = '-' + result; input.value = result; }
        function formatCurrency(value) { return (value || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }
        function showAlert(message) { document.getElementById('alert-message').textContent = message; document.getElementById('custom-alert').classList.remove('hidden'); }
        function closeAlert() { document.getElementById('custom-alert').classList.add('hidden'); }
        function downloadFile(content, filename, contentType) { const blob = new Blob([content], { type: contentType }); const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.href = url; link.setAttribute('download', filename); document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url); }
        
        const parsers = {
            mercado_pago: (texto) => { const transacoes = []; const regex = /^(\d{2}-\d{2}-\d{4})\s+(.+?)\s+\d+\s+R\$\s+(-?[\d.,]+)/; texto.split('\n').forEach(l => { const m = l.match(regex); if(m) { let [_, d, desc, vS] = m; d = d.replace(/-/g, '/'); const v = parseValue(vS); if(!isNaN(v)) transacoes.push({date:d, description:desc.trim(), value:v}); } }); return transacoes; },
            nubank: (texto) => { const transacoes = []; const regex = /(\d{2}\s[A-Z]{3})\s+(.+?)\s+(-?[\d,.]+)/i; texto.split('\n').forEach(l => { const m = l.match(regex); if (m) { const [_, d, desc, vS] = m; const v = parseValue(vS); if(!isNaN(v)) transacoes.push({ date: d, description: desc.trim(), value: v }); } }); return transacoes; },
            itau: (texto) => { const transacoes = []; const regex = /^(\d{2}\/\d{2})\s+(.+?)\s+(-?[\d.,]+,\d{2})[ C]?$/; texto.split('\n').forEach(l => { const m = l.match(regex); if (m) { const [_, d, desc, vS] = m; const v = parseValue(vS); if (!isNaN(v)) transacoes.push({ date: d, description: desc.trim(), value: v }); } }); return transacoes; },
            bradesco: (texto) => { const transacoes = []; const regex = /^(\d{2}\/\d{2})\s+(.+)\s(\d{1,3}(?:\.\d{3})*,\d{2})(\s+C|\s+D)?$/; texto.split('\n').forEach(l => { const m = l.match(regex); if (m) { let [_, d, desc, vS, tipo] = m; let v = parseValue(vS); if(tipo && tipo.trim() === 'D') v = -v; if (!isNaN(v)) transacoes.push({ date: d, description: desc.trim(), value: v }); } }); return transacoes; },
            caixa: (texto) => { const transacoes = []; const regex = /^(\d{2}\/\d{2})\s+\d+\s+(.+?)\s+([\d.,]+)\s+[DC]/; texto.split('\n').forEach(l => { const m = l.match(regex); if(m){ let [_, d, desc, vS, tipo] = m; let v = parseValue(vS); if(l.endsWith('D')) v = -v; if(!isNaN(v)) transacoes.push({date:d, description:desc.trim(), value:v}); } }); return transacoes; },
            bb: (texto) => { const transacoes = []; const regex = /^(\d{2}\/\d{2})\s+(.+?)\s+(-?[\d.,]+,\d{2})/; texto.split('\n').forEach(l => { const m = l.match(regex); if(m) { const[_,d,desc,vS]=m; const v = parseValue(vS); if(!isNaN(v)) transacoes.push({date:d,description:desc.trim(),value:v}); } }); return transacoes; },
            generico: (texto) => { const transacoes = []; const regex = /(\d{2}\/\d{2}(\/\d{2,4})?)\s+(.+?)\s+(-?R?\$\s?)?(-?[\d.,]+,\d{2})/; texto.split('\n').forEach(l => { const m = l.match(regex); if (m) { const date = m[1]; let desc = m[3]; const val = parseValue(m[5]); if (!isNaN(val)) transacoes.push({date, description:desc.trim(), value:val}); } }); return transacoes; }
        };

        function exportAllToXLSX() {
            if (income.length === 0 && expenses.length === 0) return showAlert("N√£o h√° dados para exportar.");
            const wb = XLSX.utils.book_new();
            
            const incomeData = income.map(t => ({ Data: t.date, Banco: t.bank, Descri√ß√£o: t.description, Valor: t.value }));
            const expenseData = expenses.map(t => ({ Data: t.date, Banco: t.bank, Descri√ß√£o: t.description, Valor: t.value }));
            const historicoData = generateMonthlyHistory();
            const creditMetrics = calculateCreditMetrics();
            const creditScore = calculateCreditScore(creditMetrics);
            const scoreData = [{
                'Renda Comprovada': formatCurrency(parseValue(document.getElementById('rendaComprovada').value || '0')),
                'Renda L√≠quida Estimada': formatCurrency(creditMetrics.rendaLiquida),
                'Comprometimento de Renda': creditMetrics.comprometimento,
                'Score Estimado': creditScore.score,
                'Risco Sugerido': creditScore.risco
            }];

            const ws_entradas = XLSX.utils.json_to_sheet(incomeData);
            const ws_saidas = XLSX.utils.json_to_sheet(expenseData);
            const ws_historico = XLSX.utils.json_to_sheet(historicoData);
            const ws_score = XLSX.utils.json_to_sheet(scoreData);

            XLSX.utils.book_append_sheet(wb, ws_entradas, "Entradas");
            XLSX.utils.book_append_sheet(wb, ws_saidas, "Sa√≠das");
            XLSX.utils.book_append_sheet(wb, ws_historico, "Hist√≥rico Mensal");
            XLSX.utils.book_append_sheet(wb, ws_score, "Score de Cr√©dito");

            XLSX.writeFile(wb, `Relatorio_Financeiro_${new Date().toISOString().slice(0,10)}.xlsx`);
        }
        function exportToPDF() {
            if (income.length === 0 && expenses.length === 0) return showAlert("N√£o h√° dados para exportar.");
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(18);
            doc.text("Relat√≥rio Financeiro e de Cr√©dito", 14, 22);
            doc.setFontSize(11);
            doc.setTextColor(100);
            
            const creditMetrics = calculateCreditMetrics();
            const creditScore = calculateCreditScore(creditMetrics);
            const rendaComprovada = parseValue(document.getElementById('rendaComprovada').value || '0');
            const alertaSobreGastos = creditMetrics.rendaLiquida < Math.abs(expenses.reduce((s, t) => s + t.value, 0)) ? "‚ö†Ô∏è Gasto maior que a renda (ponto de aten√ß√£o)" : "";

            doc.setFontSize(12);
            doc.text("Resumo de Cr√©dito", 14, 32);
            doc.setFontSize(10);
            doc.text(`Renda Comprovada: ${formatCurrency(rendaComprovada)}`, 14, 40);
            doc.text(`Renda L√≠quida Estimada: ${formatCurrency(creditMetrics.rendaLiquida)}`, 14, 46);
            doc.text(`Comprometimento de Renda: ${creditMetrics.comprometimento}`, 14, 52);
            doc.text(`Score Estimado: ${creditScore.score} - Risco: ${creditScore.risco}`, 14, 58);
            if(alertaSobreGastos) { doc.setTextColor(255, 0, 0); doc.text(alertaSobreGastos, 14, 64); doc.setTextColor(100); }


            const head = [['Data', 'Banco', 'Descri√ß√£o', 'Valor']];
            if (income.length > 0) {
                doc.autoTable({
                    startY: 75, head: head, body: income.map(t => [t.date, t.bank, t.description, formatCurrency(t.value)]),
                    headStyles: { fillColor: [22, 160, 133] },
                    didDrawPage: (data) => { doc.setFontSize(14); doc.text("Entradas", 14, data.cursor.y - 10); }
                });
            }
            if (expenses.length > 0) {
                doc.autoTable({
                    head: head, body: expenses.map(t => [t.date, t.bank, t.description, formatCurrency(t.value)]),
                    headStyles: { fillColor: [192, 57, 43] },
                    didDrawPage: (data) => { doc.setFontSize(14); doc.text("Sa√≠das", 14, data.cursor.y - 10); }
                });
            }
            doc.save(`Relatorio_Financeiro_${new Date().toISOString().slice(0,10)}.pdf`);
        }
        
        function exportarAprendizados() { const d = JSON.stringify(loadLearnedPatterns(), null, 2); downloadFile(d, "aprendizados.json", "application/json"); }
        function importarAprendizados(event) { const f = event.target.files[0]; if (!f) return; const r = new FileReader(); r.onload = (e) => { try { const j = JSON.parse(e.target.result); if (typeof j === 'object' && j !== null) { saveLearnedPatterns(j); showAlert("Padr√µes importados."); mostrarAprendizados(); } else { throw new Error("Formato inv√°lido"); } } catch (e) { showAlert("Erro ao importar JSON."); } }; r.readAsText(f); }
    </script>
</body>
</html>
