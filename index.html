<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sessão Cinema em Casa</title>
    <!-- Tailwind CSS para estilização -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilo para garantir que o contêiner de sugestões fique sobre outros elementos */
        #suggestions-container {
            z-index: 10;
        }

        /* Estilo para o modal de sorteio */
        #drawn-movie-container {
            transform: translateY(20px);
            opacity: 0;
            transition: all 0.3s ease-in-out;
        }
        #drawn-movie-container.visible {
            transform: translateY(0);
            opacity: 1;
        }

        /* Estilo para o modal de confirmação */
        #confirmation-modal {
            background-color: rgba(0, 0, 0, 0.75);
            transition: all 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 font-sans p-4 sm:p-8 transition-colors duration-500">

    <!-- Modal para o nome do usuário -->
    <div id="nickname-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-xl w-full max-w-md text-center">
            <h2 class="text-2xl font-bold mb-4">Bem-vindo(a)!</h2>
            <p class="mb-4 text-gray-600 dark:text-gray-300">Qual é o seu nome ou apelido para a sessão?</p>
            <input type="text" id="nickname-input" class="w-full p-3 rounded-lg border-2 border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Seu nome">
            <button id="save-nickname-button" class="mt-4 w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition duration-300">
                Começar
            </button>
        </div>
    </div>
    
    <!-- Modal de confirmação para exclusão -->
    <div id="confirmation-modal" class="fixed inset-0 hidden flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-xl w-full max-w-sm text-center">
            <h2 class="text-xl font-bold mb-4">Confirmar exclusão</h2>
            <p class="mb-6 text-gray-600 dark:text-gray-300">Tem certeza que deseja remover este filme?</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-remove-button" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition duration-300">
                    Remover
                </button>
                <button id="cancel-remove-button" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400 transition duration-300">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <div id="app-root" class="max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-blue-600 dark:text-blue-400">
                Sessão Cinema em Casa
            </h1>
            <p class="mt-2 text-lg text-gray-600 dark:text-gray-300">
                Adicione filmes e sorteie um para a noite!
            </p>
        </header>

        <main class="space-y-8">
            <!-- Formulário para adicionar filmes com sugestões -->
            <div class="relative p-6 bg-white dark:bg-gray-800 rounded-2xl shadow-lg">
                <form id="add-movie-form" class="flex flex-col sm:flex-row gap-4">
                    <input
                        type="text"
                        id="movie-input"
                        placeholder="Pesquise e adicione um filme"
                        class="flex-1 p-3 rounded-lg border-2 border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                </form>

                <!-- Container para a lista de sugestões -->
                <ul id="suggestions-container" class="absolute hidden w-full max-h-60 overflow-y-auto mt-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg">
                </ul>
            </div>

            <!-- Seção de mensagens e erros -->
            <div id="message-container"></div>
            <div id="error-container"></div>

            <!-- Seção para sortear um filme -->
            <div class="flex flex-col sm:flex-row items-center gap-4 p-6 bg-white dark:bg-gray-800 rounded-2xl shadow-lg">
                <button
                    id="draw-movie-button"
                    class="bg-purple-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-purple-700 transition duration-300 w-full flex items-center justify-center gap-2"
                    disabled
                >
                    Sortear Filme
                </button>
            </div>

            <!-- Container do filme sorteado -->
            <div id="drawn-movie-container" class="hidden"></div>
            
            <!-- Lista de filmes -->
            <div id="movies-list" class="space-y-4">
                <div id="no-movies-message" class="p-8 text-center text-gray-500 dark:text-gray-400 italic">
                    Nenhum filme adicionado ainda.
                </div>
            </div>
        </main>
    </div>

    <!-- Scripts do Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variáveis de configuração
        // Este objeto firebaseConfig pode ser visto por qualquer pessoa que inspecione o código.
        // As regras do Firestore devem ser usadas para proteger o banco de dados.
        const firebaseConfig = {
            apiKey: "AIzaSyDL7ZGUXdgJiI1PcEphUVB0lI1kBW30n_c",
            authDomain: "cinema-cosparsa.firebaseapp.com",
            projectId: "cinema-cosparsa",
            storageBucket: "cinema-cosparsa.firebasestorage.app",
            messagingSenderId: "84639168921",
            appId: "1:84639168921:web:80c8eedc0b1c8378a93b08",
            measurementId: "G-M4CLWJ26NF"
        };
        // A API key do TMDb não é uma informação sensível, mas o GitHub a detecta como um segredo.
        // A melhor forma de 'escondê-la' de forma mais segura seria com um backend, mas
        // para um app puramente de front-end, a mantemos aqui.
        const tmdbApiKey = 'f764295c27c5f107d3a8836aeeb5bdc9';

        // Inicializa o Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let userId = null;
        let userNickname = localStorage.getItem('userNickname') || null;

        // Elementos do DOM
        const appRoot = document.getElementById('app-root');
        const nicknameModal = document.getElementById('nickname-modal');
        const nicknameInput = document.getElementById('nickname-input');
        const saveNicknameButton = document.getElementById('save-nickname-button');
        const movieInput = document.getElementById('movie-input');
        const addMovieForm = document.getElementById('add-movie-form');
        const drawMovieButton = document.getElementById('draw-movie-button');
        const moviesList = document.getElementById('movies-list');
        const noMoviesMessage = document.getElementById('no-movies-message');
        const drawnMovieContainer = document.getElementById('drawn-movie-container');
        const suggestionsContainer = document.getElementById('suggestions-container');
        const messageContainer = document.getElementById('message-container');
        const errorContainer = document.getElementById('error-container');
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmRemoveButton = document.getElementById('confirm-remove-button');
        const cancelRemoveButton = document.getElementById('cancel-remove-button');
        let movieIdToRemove = null;

        // Estado do aplicativo
        let allMovies = [];
        let drawnMovieId = null;
        let isLoading = false;
        let debounceTimeout = null;

        // Função para exibir mensagens
        const showMessage = (msg, isError = false) => {
            const container = isError ? errorContainer : messageContainer;
            container.innerHTML = `<div class="p-4 ${isError ? 'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300' : 'bg-green-100 text-green-700 dark:bg-green-300'} rounded-2xl font-medium">${msg}</div></div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        };

        // Função para renderizar a lista de filmes
        const renderMovies = (movies) => {
            if (movies.length === 0) {
                noMoviesMessage.classList.remove('hidden');
                moviesList.innerHTML = ''; // Limpa a lista
                drawMovieButton.disabled = true; // Desabilita o botão de sorteio
            } else {
                noMoviesMessage.classList.add('hidden');
                const sortedMovies = movies.sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate());
                moviesList.innerHTML = sortedMovies.map(movie => `
                    <div class="flex gap-4 p-4 bg-white dark:bg-gray-800 rounded-2xl shadow-md transition-all duration-300 hover:shadow-xl">
                        <img
                            src="${movie.poster_path ? `https://image.tmdb.org/t/p/w200${movie.poster_path}` : 'https://placehold.co/200x300/e2e8f0/000000?text=Sem+Poster'}"
                            alt="Pôster do filme ${movie.title}"
                            class="w-24 h-36 sm:w-32 sm:h-48 object-cover rounded-lg shadow-md"
                        />
                        <div class="flex-1">
                            <div class="flex items-start justify-between">
                                <h3 class="text-lg sm:text-xl font-bold leading-tight">
                                    ${movie.title}
                                    ${movie.isWatched ? `<span class="ml-2 text-green-500"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-circle"><path d="M22 11.08V12a10 10 0 1 1-5.93-8.6"></path><path d="m11 12 2 2 4-4"></path></svg></span>` : ''}
                                </h3>
                                <div class="flex items-center text-sm text-gray-500 dark:text-gray-400">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-star text-yellow-400 mr-1"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                                    ${movie.vote_average ? movie.vote_average.toFixed(1) : 'N/A'}
                                </div>
                            </div>
                            <p class="mt-2 text-sm sm:text-base text-gray-600 dark:text-gray-300 line-clamp-3">
                                ${movie.overview || 'Sinopse não disponível.'}
                            </p>
                            <div class="mt-2 text-sm text-gray-400">Adicionado por: ${movie.addedBy}</div>
                            <div class="mt-4 flex gap-2">
                                ${!movie.isWatched ? `
                                    <button onclick="markAsWatched('${movie.id}')" class="bg-green-600 text-white px-3 py-1 rounded-lg text-sm font-semibold hover:bg-green-700 transition">
                                        Marcar como Visto
                                    </button>
                                ` : `
                                    <button onclick="resetMovie('${movie.id}')" class="bg-yellow-500 text-white px-3 py-1 rounded-lg text-sm font-semibold hover:bg-yellow-600 transition flex items-center gap-1">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-rotate-ccw"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1.05 6.74 2.9L21 8.5"></path><path d="M21 3v5h-5"></path></svg>
                                        Desmarcar
                                    </button>
                                `}
                                ${movie.addedBy === userNickname || movie.addedBy === userId ? `
                                    <button onclick="showConfirmationModal('${movie.id}')" class="bg-red-600 text-white px-3 py-1 rounded-lg text-sm font-semibold hover:bg-red-700 transition flex items-center gap-1">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                                        Remover
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
                
                const unwatchedMovies = movies.filter(m => !m.isWatched);
                drawMovieButton.disabled = unwatchedMovies.length === 0;
            }
        };

        // Função para buscar sugestões de filmes (com debounce)
        const fetchSuggestions = async (query) => {
            if (debounceTimeout) {
                clearTimeout(debounceTimeout);
            }
            if (query.length < 3) {
                suggestionsContainer.innerHTML = '';
                suggestionsContainer.classList.add('hidden');
                return;
            }

            debounceTimeout = setTimeout(async () => {
                try {
                    const tmdbUrl = `https://api.themoviedb.org/3/search/movie?api_key=${tmdbApiKey}&query=${encodeURIComponent(query)}&language=pt-BR`;
                    const response = await fetch(tmdbUrl);
                    const data = await response.json();
                    
                    if (data.results && data.results.length > 0) {
                        renderSuggestions(data.results);
                    } else {
                        suggestionsContainer.innerHTML = '';
                        suggestionsContainer.classList.add('hidden');
                    }
                } catch (err) {
                    console.error("Erro ao buscar sugestões:", err);
                    suggestionsContainer.innerHTML = '';
                    suggestionsContainer.classList.add('hidden');
                }
            }, 500);
        };

        // Função para renderizar a lista de sugestões
        const renderSuggestions = (suggestions) => {
            suggestionsContainer.innerHTML = suggestions.map(movie => `
                <li class="p-3 hover:bg-gray-200 dark:hover:bg-gray-600 cursor-pointer flex items-center gap-3 transition-colors duration-200"
                    data-movie-id="${movie.id}"
                    data-movie-title="${movie.title}"
                    data-movie-poster="${movie.poster_path}"
                    data-movie-overview="${movie.overview}"
                    data-movie-rating="${movie.vote_average}"
                >
                    <img 
                        src="${movie.poster_path ? `https://image.tmdb.org/t/p/w92${movie.poster_path}` : 'https://placehold.co/92x138/e2e8f0/000000?text=S/P'}"
                        alt="Pôster de ${movie.title}"
                        class="w-12 h-18 object-cover rounded-md"
                    />
                    <div>
                        <p class="font-semibold text-gray-900 dark:text-gray-100">${movie.title}</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">${movie.release_date ? movie.release_date.substring(0, 4) : 'Ano desconhecido'}</p>
                    </div>
                </li>
            `).join('');
            suggestionsContainer.classList.remove('hidden');
        };

        // Event listener para o campo de busca
        movieInput.addEventListener('input', (e) => {
            fetchSuggestions(e.target.value);
        });

        // Event listener para selecionar uma sugestão
        suggestionsContainer.addEventListener('mousedown', (e) => {
            const li = e.target.closest('li');
            if (li) {
                const movie = {
                    title: li.dataset.movieTitle,
                    poster_path: li.dataset.moviePoster,
                    overview: li.dataset.movieOverview,
                    vote_average: parseFloat(li.dataset.movieRating),
                };
                addMovieToFirestore(movie);
            }
        });
        
        // Inicializa o app após o DOM carregar
        window.onload = () => {
             // Checa se o nickname já está salvo
            if (!userNickname) {
                nicknameModal.classList.remove('hidden');
            } else {
                nicknameModal.classList.add('hidden');
                 // Inicia a autenticação do Firebase se o nickname existir
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        // Listener para a coleção de filmes
                        const moviesCollection = collection(db, 'movies');
                        onSnapshot(moviesCollection, (snapshot) => {
                            allMovies = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            renderMovies(allMovies);
                        }, (error) => {
                            console.error("Erro ao buscar filmes:", error);
                            showMessage("Erro ao carregar a lista de filmes. Verifique as regras do Firebase.", true);
                        });
                    } else {
                        try {
                            await signInAnonymously(auth);
                        } catch (error) {
                            console.error("Falha ao autenticar anonimamente:", error);
                            showMessage("Erro de autenticação. Por favor, verifique a configuração do seu projeto.", true);
                        }
                    }
                });
            }
        };

        // Event listener do modal de nickname
        saveNicknameButton.addEventListener('click', () => {
            const nickname = nicknameInput.value.trim();
            if (nickname) {
                localStorage.setItem('userNickname', nickname);
                userNickname = nickname;
                nicknameModal.classList.add('hidden');
                window.location.reload(); // Recarrega a página para inicializar o app com o nickname
            }
        });


        // Função para adicionar um filme ao Firestore
        const addMovieToFirestore = async (movie) => {
            if (isLoading) return;
            isLoading = true;
            
            try {
                const moviesCollection = collection(db, 'movies');
                await addDoc(moviesCollection, {
                    ...movie,
                    isWatched: false,
                    createdAt: new Date(),
                    addedBy: userNickname,
                });
                movieInput.value = '';
                suggestionsContainer.classList.add('hidden');
                showMessage(`Filme "${movie.title}" adicionado com sucesso!`);
            } catch (error) {
                console.error("Erro ao adicionar filme:", error);
                showMessage("Ocorreu um erro ao adicionar o filme. Verifique as regras do Firebase.", true);
            } finally {
                isLoading = false;
            }
        };

        // Event listener para o botão de sortear
        drawMovieButton.addEventListener('click', () => {
            const unwatchedMovies = allMovies.filter(m => !m.isWatched);
            if (unwatchedMovies.length === 0) {
                showMessage("Todos os filmes já foram assistidos!");
                drawnMovieContainer.classList.add('hidden');
                return;
            }
            
            const randomIndex = Math.floor(Math.random() * unwatchedMovies.length);
            const drawnMovie = unwatchedMovies[randomIndex];
            drawnMovieId = drawnMovie.id;

            // Renderiza o card completo do filme sorteado
            drawnMovieContainer.innerHTML = `
                <div class="p-6 bg-purple-600 text-white rounded-2xl shadow-xl space-y-4">
                    <h2 class="text-2xl font-bold text-center">Filme Sorteado!</h2>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <img
                            src="${drawnMovie.poster_path ? `https://image.tmdb.org/t/p/w200${drawnMovie.poster_path}` : 'https://placehold.co/200x300/e2e8f0/000000?text=Sem+Poster'}"
                            alt="Pôster do filme ${drawnMovie.title}"
                            class="w-full sm:w-32 h-auto object-cover rounded-lg shadow-md"
                        />
                        <div class="flex-1">
                            <h3 class="text-lg sm:text-xl font-bold leading-tight">
                                ${drawnMovie.title}
                            </h3>
                            <div class="flex items-center text-sm text-gray-200 mt-1">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-star text-yellow-300 mr-1"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                                ${drawnMovie.vote_average ? drawnMovie.vote_average.toFixed(1) : 'N/A'}
                            </div>
                            <p class="mt-2 text-sm sm:text-base text-gray-200">
                                ${drawnMovie.overview || 'Sinopse não disponível.'}
                            </p>
                        </div>
                    </div>
                    <button onclick="markAsWatched('${drawnMovie.id}')" class="mt-4 w-full bg-green-500 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-green-600 transition">
                        Marcar como Visto
                    </button>
                </div>
            `;
            drawnMovieContainer.classList.remove('hidden');
            drawnMovieContainer.classList.add('visible'); // Adiciona classe para animação
            showMessage(`Filme sorteado: "${drawnMovie.title}"!`);
        });

        // Função global para marcar como assistido (chamada do HTML)
        window.markAsWatched = async (movieId) => {
            try {
                const movieRef = doc(db, 'movies', movieId);
                await updateDoc(movieRef, {
                    isWatched: true,
                    watchedAt: new Date()
                });
                showMessage(`Filme marcado como assistido.`);
                drawnMovieContainer.classList.remove('visible'); // Remove a animação do card de sorteio
                drawnMovieContainer.classList.add('hidden');
            } catch (error) {
                console.error("Erro ao marcar como assistido:", error);
                showMessage("Ocorreu um erro ao atualizar o filme.", true);
            }
        };
        
        // Função global para desmarcar (chamada do HTML)
        window.resetMovie = async (movieId) => {
             try {
                const movieRef = doc(db, 'movies', movieId);
                await updateDoc(movieRef, {
                    isWatched: false,
                    watchedAt: null
                });
                showMessage(`Filme desmarcado.`);
            } catch (error) {
                console.error("Erro ao desmarcar o filme:", error);
                showMessage("Ocorreu um erro ao atualizar o filme.", true);
            }
        };

        // Função global para remover filme (chamada do HTML)
        window.removeMovie = async (movieId) => {
             confirmationModal.classList.remove('hidden');
             movieIdToRemove = movieId;
        };

        // Event listener para o botão de marcar filme sorteado
        window.addEventListener('click', (event) => {
            if(event.target && event.target.id === 'mark-watched-button') {
                if(drawnMovieId) {
                    window.markAsWatched(drawnMovieId);
                    drawnMovieId = null;
                }
            }
        });

        confirmRemoveButton.addEventListener('click', async () => {
            if (movieIdToRemove) {
                try {
                    const movieRef = doc(db, 'movies', movieIdToRemove);
                    await deleteDoc(movieRef);
                    showMessage("Filme removido com sucesso!");
                    movieIdToRemove = null;
                } catch (error) {
                    console.error("Erro ao remover o filme:", error);
                    showMessage("Ocorreu um erro ao remover o filme.", true);
                } finally {
                    confirmationModal.classList.add('hidden');
                }
            }
        });

        cancelRemoveButton.addEventListener('click', () => {
            confirmationModal.classList.add('hidden');
            movieIdToRemove = null;
        });

    </script>
</body>
</html>
